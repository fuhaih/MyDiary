## 密码复杂度

CentOS7/RHEL7 开始使用pam_pwquality模块进行密码复杂度策略的控制管理。pam_pwquality替换了原来Centos6/RHEL6中的pam_cracklib模块，并向后兼容。

>编辑system-auth

```s
vim /etc/pam.d/system-auth
```

修改策略
```s
password  requisite  pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type= minlen=8 lcredit=-1 ucredit=-1 dcredit=-1 ocredit=-1 difok=5 enforce_for_root
```

>参数说明

* minlen = 8 ，密码长度至少8位；
* lcredit=-1，至少包含一个小写字母；
* ucredit=-1，至少包含一个大写字母；
* dcredit=-1，至少包含要给数字；
* ocredit=-1，至少包含一个特殊字符；
* difok=5，新密码最多与旧密码重复5个字符；
* enforce_for_root，对root强制执行密码复杂度策略。
* retry=3：密码配置失败时，可以重试的次数；

负数：代表最少出现次数，正数：代表最多出现次数

## 密码有效期

>编辑login.defs

```
vim /etc/login.defs
```

配置策略

```s
 #密码的最大有效期

PASS_MAX_DAYS   180

#是否可修改密码，多少天后可修改

PASS_MIN_DAYS   0

#密码最小长度，pam_pwquality设置优先

PASS_MIN_LEN    8

#密码失效前多少天在用户登录时通知用户修改密码

PASS_WARN_AGE   15
```
以上设置只针对新用户生效，原来用户不生效。

原有用户设置密码有效期，可以使用命令：

```s
# 90天有效期，提前15天提醒
chage -M 90 -W 15 root

# 查看账户有效期
chage -l root
```


## 登录回话超时

>打开profile

```s
vim /etc/profile
```

```s
HISTSIZE=1000
# 配置10分钟超时
TIMOUT=600
```

```s
source /etc/profile
```

## 登录失败锁定

输错5次密码，账户锁定30分钟

>编辑system-auth

```s
vim /etc/pam.d/system-auth
```

修改策略
```s0 root_unlock_time=60
auth       required     pam_tally2.so deny=5 even_deny_root unlock_time=1800 
```

* system-auth 是只对本地生效

* password-auth 会对ssh连接生效，但是需要重启sshd服务或者重启系统，也可以配置`/etc/pam.d/sshd`

* auth需要放在第一行

## 登录异常排查

查看`/var/log/secure`文件，排查问题，如果是模块加载问题，很可能是配置文件在windows上编辑导致的，

deny问题：
登录失败太多次可能会锁定账户，导致无法登录

```s
pam_tally2 --reset -u root
```

此次是没有其他账户可登录来执行命令，但是xftp打开着，直接使用xftp修改auth配置（从其他服务器修改后再通过xftp覆盖过去），去掉pam_tally2校验，再登录进去执行重置指令，再重新配置校验