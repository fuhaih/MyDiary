# .NET Core

## 调试

>IIS Express

在启动项中选择`IIS Express`，就会通过`IIS Express`来寄宿服务，启动程序,启动配置一般在`launchSettings.json`中进行配置
```json
{
  "iisSettings": {
    "windowsAuthentication": false, 
    "anonymousAuthentication": true, 
    "iisExpress": {
      "applicationUrl": "http://localhost:55179",
      //"sslPort": 44308
    }
  },
  "profiles": {
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "HongKouEnergyPlatform": {
      "commandName": "Project",
      "launchBrowser": true,
      "applicationUrl": "http://localhost:5000",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
```

>Kestrel

[Kestrel](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-3.1)

在`appsettings.json`中进行如下配置

```json
{
  "Kestrel": {
    "Limits":{
      "MaxConcurrentConnections": 100,
      "MaxConcurrentUpgradedConnections": 100
    },
    "DisableStringReuse": true,
    "Endpoints": {
      "Http": {
        "Url": "http://localhost:5000"
      },
      "HttpsInlineCertFile": {
        "Url": "https://localhost:5001",
        "Certificate": {
          "Path": "<path to .pfx file>",
          "Password": "<certificate password>"
        }
      },
      "HttpsInlineCertStore": {
        "Url": "https://localhost:5002",
        "Certificate": {
          "Subject": "<subject; required>",
          "Store": "<certificate store; required>",
          "Location": "<location; defaults to CurrentUser>",
          "AllowInvalid": "<true or false; defaults to false>"
        }
      },
      "HttpsDefaultCert": {
        "Url": "https://localhost:5003"
      },
      "Https": {
        "Url": "https://*:5004",
        "Certificate": {
          "Path": "<path to .pfx file>",
          "Password": "<certificate password>"
        }
      }
    },
    "Certificates": {
      "Default": {
        "Path": "<path to .pfx file>",
        "Password": "<certificate password>"
      }
    }
  }
}

```

然后在修改`Startup`的`ConfigureServices`

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddControllersWithViews().AddJsonOptions(options=> {
        options.JsonSerializerOptions.Converters.Add(new DatetimeJsonConverter());
    });
    //设置kestrel
    services.Configure<KestrelServerOptions>(Configuration.GetSection("Kestrel"));
}
```

然后在启动项中选择项目名称

## DI容器

## 配置

>json配置读取中文乱码

json文件默认的编码格式是`ANSI`,把json文件的编码格式设置为`UTF-8`就可以了

## Filter使用

>异常处理

## 中间件

## 日志

使用NLog替换原生的日志



## IdentityServer4

## 发布

> 程序

名称：HongKouEnergyPlatform

发布位置：/var/www/HongKouEnergyPlatform

启动程序命令：dotnet HongKouEnergyPlatform.dll

> 编写服务文件

```
cd /usr/lib/systemd/system
vim HKEnergyServer.service
```

```
[Unit]
Description=HKEnergyServer
[Service]
Type=simple
WorkingDirectory=/var/www/HongKouEnergyPlatform
ExecStart=/usr/local/bin/dotnet HongKouEnergyPlatform.dll
Restart=always
[Install]
WantedBy=multi-user.target
```

`WorkingDirectory`为程序的发布路径

`ExecStart`的dotnet命令需要写完整路径。

> 启动程序

```sh
# 重载系统服务
systemctl daemon-reload
# 启动程序
systemctl start HKEnergyServer.service
# 查看状态
systemctl status HKEnergyServer.service
# 开机启动
systemctl enable HKEnergyServer.service
```

## IAction<T>

>使用NewtonsoftJson 替换System.Text.Json

## NewtonsoftJson

## System.Text.Json

>DateTime格式的处理



# swagger

nuget 安装 `Swashbuckle.AspNetCore`
>配置

```csharp
public void ConfigureServices(IServiceCollection services)
{
    //配置swagger
    services.AddSwaggerGen(c =>
    {
        c.SwaggerDoc("v1", new OpenApiInfo { Title = "HongKouEnergyPlatform API", Version = "v1" });
        var xmlFile = $"{Assembly.GetExecutingAssembly().GetName().Name}.xml";
        var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
        c.IncludeXmlComments(xmlPath);//配置xml文件路径，xml的生成要在项目属性中设置。
        c.IgnoreObsoleteActions();//忽略Obsolete
    });
}
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
    }
    else
    {
        app.UseExceptionHandler("/Home/Error");
    }
    //app.UseHttpsRedirection();
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "HongKouEnergyPlatform V1");
        //路由前缀
        c.RoutePrefix = "swagger";
    });
    //swagger配置需要在Routing配置之前
    app.UseRouting();
}

```


